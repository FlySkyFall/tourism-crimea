<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{csrfToken}}">
  <title>{{#if tour.title}}{{tour.title}}{{else}}–¢—É—Ä{{/if}} - –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π –∫—Ä–∞–π</title>
  <script src="https://unpkg.com/@popperjs/core@2"></script>
  <script src="https://unpkg.com/tippy.js@6"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="/css/style.css">
  <style>
    #tourMap { height: 400px; width: 100%; }
    #routeMap { height: 400px; width: 100%; display: block; }
    #calendar { display: block; min-height: 400px; width: 100%; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  {{> navbar}}

  <section class="py-12 bg-white">
    <div class="container mx-auto px-4">
      <div class="relative {{#if tour.isHotDeal}}hot-deal{{/if}}">
        {{#if tour.isHotDeal}}
          <span class="hot-deal-badge">üî• –ì–æ—Ä—è—â–∏–π —Ç—É—Ä!</span>
        {{/if}}
        <h1 class="text-3xl font-bold mb-6">{{#if tour.title}}{{tour.title}}{{else}}–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è{{/if}}</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div>
            {{#if tour.images.length}}
              <img src="{{get tour.images 0}}" alt="{{tour.title}}" class="w-full h-96 object-cover rounded-lg">
            {{else}}
              <div class="w-full h-96 bg-gray-200 rounded-lg flex items-center justify-center">
                <p class="text-gray-500">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
              </div>
            {{/if}}
            <p id="tour-price" class="text-blue-600 font-bold text-xl mt-2">
              {{#if tour.price}}
                {{formatPrice tour.price}} ‚ÇΩ –∑–∞ —á–µ–ª–æ–≤–µ–∫–∞
                {{#if tour.discounts.groupDiscount.enabled}}
                  <span class="text-green-600 block text-sm">–°–∫–∏–¥–∫–∞ {{tour.discounts.groupDiscount.percentage}}% –∑–∞ –≥—Ä—É–ø–ø—É –æ—Ç {{tour.discounts.groupDiscount.minParticipants}} —á–µ–ª.</span>
                {{/if}}
                {{#if tour.discounts.seasonalDiscount.enabled}}
                  <span class="text-green-600 block text-sm">–°–µ–∑–æ–Ω–Ω–∞—è —Å–∫–∏–¥–∫–∞ {{tour.discounts.seasonalDiscount.percentage}}% –¥–æ {{formatDate tour.discounts.seasonalDiscount.endDate}}</span>
                {{/if}}
                {{#if tour.isHotDeal}}
                  <span class="text-green-600 block text-sm">–°–∫–∏–¥–∫–∞ –≥–æ—Ä—è—â–µ–≥–æ —Ç—É—Ä–∞ {{tour.discounts.hotDealDiscount.percentage}}%</span>
                {{/if}}
              {{else}}
                –¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞
              {{/if}}
            </p>
          </div>
          <div>
            <p class="text-gray-600 mb-4">{{#if tour.description}}{{tour.description}}{{else}}–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç{{/if}}</p>
            <p class="mb-2"><strong>–¢–∏–ø:</strong> 
              {{#if tour.type}}
                {{#if (eq tour.type 'active')}}–ê–∫—Ç–∏–≤–Ω—ã–π
                {{else if (eq tour.type 'excursion')}}–≠–∫—Å–∫—É—Ä—Å–∏–æ–Ω–Ω—ã–π
                {{else if (eq tour.type 'camping')}}–ö–µ–º–ø–∏–Ω–≥
                {{else if (eq tour.type 'health')}}–û–∑–¥–æ—Ä–æ–≤–∏—Ç–µ–ª—å–Ω—ã–π
                {{else}}–ü–∞—Å—Å–∏–≤–Ω—ã–π{{/if}}
              {{else}}
                –ù–µ —É–∫–∞–∑–∞–Ω
              {{/if}}
            </p>
            <p class="mb-2"><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> {{#if tour.durationDays}}{{tour.durationDays}} –¥–Ω–µ–π{{else}}–ù–µ —É–∫–∞–∑–∞–Ω–∞{{/if}}</p>
            <p class="mb-2"><strong>–†–µ–≥–∏–æ–Ω:</strong> {{#if tour.location.region}}{{tour.location.region}}{{else}}–ù–µ —É–∫–∞–∑–∞–Ω{{/if}}</p>
            <p class="mb-2"><strong>–†–∞–∑–º–µ—Ä –≥—Ä—É–ø–ø—ã:</strong> {{#if tour.minGroupSize}}{{tour.minGroupSize}}-{{tour.maxGroupSize}} —á–µ–ª–æ–≤–µ–∫{{else}}–ù–µ —É–∫–∞–∑–∞–Ω{{/if}}</p>
            {{#if (or (eq tour.type 'passive') (eq tour.type 'health'))}}
              <p class="mb-2"><strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –æ—Ç–µ–ª—è:</strong> {{#if tour.hotelCapacity}}{{tour.hotelCapacity}} —á–µ–ª–æ–≤–µ–∫{{else}}–ù–µ —É–∫–∞–∑–∞–Ω–∞{{/if}}</p>
            {{/if}}
            <p class="mb-4"><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> {{#if tour.rating}}{{tour.rating}} ({{tour.reviewsCount}} –æ—Ç–∑—ã–≤–æ–≤){{else}}–ù–µ—Ç —Ä–µ–π—Ç–∏–Ω–≥–∞{{/if}}</p>
          </div>
        </div>

        <div class="mt-8">
          <h2 class="text-2xl font-bold mb-4">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</h2>
          <div id="tourMap" class="rounded-lg"></div> <!-- –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–∞—Ä—Ç–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ -->
        </div>

        {{#if (eq tour.type 'excursion')}}
          {{#if tour.route}}
            <div class="mt-8">
              <h2 class="text-2xl font-bold mb-4">–ú–∞—Ä—à—Ä—É—Ç</h2>
              <div id="routeMap" class="rounded-lg"></div>
            </div>
          {{else}}
            <div class="mt-8">
              <p class="text-gray-600">–ú–∞—Ä—à—Ä—É—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ç—É—Ä–∞ –Ω–µ —É–∫–∞–∑–∞–Ω.</p>
            </div>
          {{/if}}
        {{/if}}

        <div class="mt-8">
          <h2 class="text-2xl font-bold mb-4">–ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏</h2>
          <div id="calendar" class="bg-white p-4 rounded-lg"></div>
        </div>

        {{#if user}}
          {{#if hasActiveBooking}}
            <p class="mt-4 text-red-600">–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</p>
          {{else}}
            <div class="mt-8 bg-gray-100 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-4">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä</h3>
              <form id="booking-form">
                <input type="hidden" name="tourId" value="{{tour._id}}">
                <input type="hidden" name="_csrf" value="{{csrfToken}}">
                <input type="hidden" id="totalPrice" name="totalPrice">
                <div class="mb-4">
                  <label for="tourDate" class="block text-gray-700 mb-2">–î–∞—Ç–∞ —Ç—É—Ä–∞:</label>
                  {{#if (or (eq tour.type 'active') (eq tour.type 'camping') (eq tour.type 'excursion'))}}
                    <select id="tourDate" name="tourDate" class="w-full border rounded-lg px-4 py-2" required>
                      <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</option>
                    </select>
                  {{else}}
                    <input type="date" id="tourDate" name="tourDate" class="w-full border rounded-lg px-4 py-2" min="{{seasonStart}}" max="{{seasonEnd}}" required>
                  {{/if}}
                </div>
                <div class="mb-4">
                  <label for="participants" class="block text-gray-700 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</label>
                  <input type="number" id="participants" name="participants" min="1" max="{{#if tour.maxGroupSize}}{{tour.maxGroupSize}}{{else}}10{{/if}}" class="w-full border rounded-lg px-4 py-2" required>
                </div>
                {{#if tour.accommodation}}
                  {{#if tour.accommodation.type}}
                    {{#if (or (eq tour.accommodation.type 'hotel') (eq tour.accommodation.type 'sanatorium'))}}
                      {{#if tour.accommodation.hotel}}
                        {{#if (isObject tour.accommodation.hotel)}}
                          {{#if tour.accommodation.hotel.roomTypes}}
                            <div class="mb-4">
                              <label for="roomType" class="block text-gray-700 mb-2">–¢–∏–ø –Ω–æ–º–µ—Ä–∞:</label>
                              <select id="roomType" name="roomType" class="w-full border rounded-lg px-4 py-2" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –Ω–æ–º–µ—Ä–∞</option>
                                {{#each tour.accommodation.hotel.roomTypes}}
                                  <option value="{{this}}">{{lookup ../roomTypeLabels this}}</option>
                                {{/each}}
                              </select>
                            </div>
                          {{/if}}
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  {{/if}}
                {{/if}}
                <p id="total-price-display" class="text-lg font-semibold mb-4">–ò—Ç–æ–≥–æ–≤–∞—è —Ü–µ–Ω–∞: 0 ‚ÇΩ</p>
                <p id="booking-error" class="text-red-600 mb-4 hidden"></p>
                <p id="booking-success" class="text-green-600 mb-4 hidden"></p>
                <button type="submit" id="book-tour-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
              </form>
            </div>
          {{/if}}
        {{else}}
          <p class="mt-4 text-gray-600">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—É—Ä.</p>
        {{/if}}

        <div class="mt-8">
          <h2 class="text-2xl font-bold mb-4">–û—Ç–∑—ã–≤—ã</h2>
          {{#if error}}
            <p class="text-red-600 mb-4">{{error}}</p>
          {{/if}}
          {{#if tour.reviews.length}}
            <div class="space-y-4">
              {{#each tour.reviews}}
                <div class="bg-gray-100 p-4 rounded-lg">
                  <p class="text-gray-700 font-semibold">{{this.userId.username}}</p>
                  <p class="text-yellow-500">–û—Ü–µ–Ω–∫–∞: {{this.rating}} / 5</p>
                  <p class="text-gray-600">{{this.comment}}</p>
                  <p class="text-gray-500 text-sm">{{formatDate this.createdAt}}</p>
                </div>
              {{/each}}
            </div>
          {{else}}
            <p class="text-gray-600">–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
          {{/if}}

          {{#if (and user (not hasReviewed))}}
            <div class="mt-6 bg-gray-100 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-4">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h3>
              <form action="/tours/{{tour._id}}/reviews" method="POST">
                <input type="hidden" name="_csrf" value="{{csrfToken}}">
                <div class="mb-4">
                  <label for="rating" class="block text-gray-700 mb-2">–û—Ü–µ–Ω–∫–∞ (1-5):</label>
                  <select name="rating" id="rating" class="w-full border rounded-lg px-4 py-2" required>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                  </select>
                </div>
                <div class="mb-4">
                  <label for="comment" class="block text-gray-700 mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                  <textarea name="comment" id="comment" class="w-full border rounded-lg px-4 py-2" rows="4" required></textarea>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
              </form>
            </div>
          {{else}}
            <p class="mt-4 text-gray-600">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
          {{/if}}
        </div>

        <div class="mt-8">
          <h2 class="text-2xl font-bold mb-4">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-xl font-semibold mb-2">–†–∞–∑–º–µ—â–µ–Ω–∏–µ</h3>
              <p><strong>–¢–∏–ø:</strong> 
                {{#if tour.accommodation}}
                  {{#if tour.accommodation.type}}
                    {{#if (eq tour.accommodation.type 'hotel')}}–û—Ç–µ–ª—å
                    {{else if (eq tour.accommodation.type 'sanatorium')}}–°–∞–Ω–∞—Ç–æ—Ä–∏–π
                    {{else if (eq tour.accommodation.type 'camping')}}–ö–µ–º–ø–∏–Ω–≥
                    {{else if (eq tour.accommodation.type 'retreat')}}–†–µ—Ç—Ä–∏—Ç
                    {{else}}–ë–µ–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è{{/if}}
                  {{else}}
                    –ù–µ —É–∫–∞–∑–∞–Ω
                  {{/if}}
                {{else}}
                  –ë–µ–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                {{/if}}
              </p>
              {{#if tour.accommodation}}
                {{#if tour.accommodation.hotel}}
                  {{#if (isObject tour.accommodation.hotel)}}
                    <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {{#if tour.accommodation.hotel.name}}{{tour.accommodation.hotel.name}}{{else}}–ù–µ —É–∫–∞–∑–∞–Ω–æ{{/if}}</p>
                    <p><strong>–†–µ–π—Ç–∏–Ω–≥:</strong> {{#if tour.accommodation.hotel.rating}}{{tour.accommodation.hotel.rating}}/5{{else}}–ù–µ —É–∫–∞–∑–∞–Ω{{/if}}</p>
                    <p><strong>–£–¥–æ–±—Å—Ç–≤–∞:</strong> 
                      {{#if tour.accommodation.hotel.amenities}}
                        {{#each tour.accommodation.hotel.amenities}}
                          {{this}}{{#unless @last}}, {{/unless}}
                        {{else}}
                          –ù–µ—Ç —É–¥–æ–±—Å—Ç–≤
                        {{/each}}
                      {{else}}
                        –ù–µ—Ç —É–¥–æ–±—Å—Ç–≤
                      {{/if}}
                    </p>
                    <p><strong>–¢–∏–ø—ã –Ω–æ–º–µ—Ä–æ–≤:</strong> 
                      {{#if tour.accommodation.hotel.roomTypes}}
                        {{#each tour.accommodation.hotel.roomTypes}}
                          {{#if (eq this 'standard')}}–û–±—ã—á–Ω—ã–π
                          {{else if (eq this 'standardWithAC')}}–û–±—ã—á–Ω—ã–π —Å –∫–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä–æ–º
                          {{else}}–õ—é–∫—Å{{/if}}{{#unless @last}}, {{/unless}}
                        {{else}}
                          –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                        {{/each}}
                      {{else}}
                        –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                      {{/if}}
                    </p>
                  {{else}}
                    <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                  {{/if}}
                {{else}}
                  <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                {{/if}}
              {{else}}
                <p>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–µ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
              {{/if}}
            </div>
            <div>
              <h3 class="text-xl font-semibold mb-2">–°–µ–∑–æ–Ω</h3>
              <p><strong>–ù–∞—á–∞–ª–æ:</strong> {{#if tour.season.start}}{{formatDate tour.season.start}}{{else}}–ù–µ —É–∫–∞–∑–∞–Ω–æ{{/if}}</p>
              <p><strong>–ö–æ–Ω–µ—Ü:</strong> {{#if tour.season.end}}{{formatDate tour.season.end}}{{else}}–ù–µ —É–∫–∞–∑–∞–Ω–æ{{/if}}</p>
            </div>
          </div>

          <h3 class="text-xl font-semibold mt-6 mb-2">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
          <ul class="list-disc pl-6">
            {{#if tour.activities}}
              {{#each tour.activities}}
                <li>{{this.name}} ({{this.durationHours}} —á, {{#if this.equipmentRequired}}—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ{{else}}–±–µ–∑ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è{{/if}})</li>
              {{else}}
                <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</p>
              {{/each}}
            {{else}}
              <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</p>
            {{/if}}
          </ul>

          <h3 class="text-xl font-semibold mt-6 mb-2">–≠–∫—Å–∫—É—Ä—Å–∏–∏</h3>
          <ul class="list-disc pl-6">
            {{#if tour.excursions}}
              {{#each tour.excursions}}
                <li>{{this.name}} ({{this.durationHours}} —á, {{this.price}} ‚ÇΩ)</li>
              {{else}}
                <p>–ù–µ—Ç —ç–∫—Å–∫—É—Ä—Å–∏–π</p>
              {{/each}}
            {{else}}
              <p>–ù–µ—Ç —ç–∫—Å–∫—É—Ä—Å–∏–π</p>
            {{/if}}
          </ul>

          <h3 class="text-xl font-semibold mt-6 mb-2">–í–∫–ª—é—á—ë–Ω–Ω—ã–µ —É—Å–ª—É–≥–∏</h3>
          <ul class="list-disc pl-6">
            {{#if tour.includedServices}}
              {{#each tour.includedServices}}
                <li>{{this}}</li>
              {{else}}
                <p>–ù–µ—Ç –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —É—Å–ª—É–≥</p>
              {{/each}}
            {{else}}
              <p>–ù–µ—Ç –≤–∫–ª—é—á—ë–Ω–Ω—ã—Ö —É—Å–ª—É–≥</p>
            {{/if}}
          </ul>
        </div>
      </div>
    </div>
  </section>

  {{> footer}}

  <script>
    try {
      window.tourData = {{{json tour}}} || {
        location: { coordinates: { lat: 44.7204, lng: 37.7716 }, region: 'Default Region' },
        title: '–¢—É—Ä',
        route: [] // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ route –≤—Å–µ–≥–¥–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
      };
      console.log('window.tourData initialized:', window.tourData);
      console.log('Route data:', window.tourData.route); // –û—Ç–ª–∞–¥–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞
    } catch (error) {
      console.error('Error initializing window.tourData:', error);
      window.tourData = {
        location: { coordinates: { lat: 44.7204, lng: 37.7716 }, region: 'Default Region' },
        title: '–¢—É—Ä',
        route: []
      };
    }
  </script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>
  <script src="/js/booking.js"></script>
  <script src="/js/maps.js"></script>
</body>
</html>